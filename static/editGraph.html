<!DOCTYPE html>
<html>
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link rel="stylesheet" href="css/bootstrap.min.css">
 <script src="js/jquery.min.js"></script>
 <script src="js/highcharts.js"></script>
 <script src="js/highcharts-more.js"></script>
 <script src="js/draggable-points.js"></script>
</head>
<body class="container" style="width: 100%">
 <div id="container" style="width: 100%; height: 400px"></div>
 <div class="text-center">
  <button type="button" class="btn btn-primary" onClick="saveGraphData()">Save</button>
 </div>
 <script>
var chart; //http://www.highcharts.com/docs/chart-concepts/axes
var lastSerie;

$(document).ready(function() {
	$.urlParam = function(name) {
			var results = new RegExp('[\?&amp;]' + name + '=([^&amp;#]*)').exec(window.location.href);
			return (results != null && results[1]) || null;
		};

	var graphId = $.urlParam('id');

	initChart();
	if (graphId != null)
		$.ajax({
				type: 'GET',
				url:  '/graph/' + graphId,
				dataType: 'json',
				success: function(json)
				{
					convertDataToSerie(json);
				},
				error: function(e)
				{
					alert('Communication error: ' + e.message);
				}
			});
	else
		alert('No graph id provided !!!');
});

function convertDataToSerie(json)
{
	var serie = [];
	var lastValue = 12;
	var lastTime = 0;

	for (var key in json.data)
	{
		var data = json.data[key];
		var dataTime = parseInt(data.time);
		var dataValue = parseFloat(data.value);

		addToSerie(serie, dataTime, lastValue, lastTime);
		lastValue = dataValue;
		lastTime = dataTime;
	}
	addToSerie(serie, 2400, lastValue, lastTime);
	chart.addSeries({
			id: json.id,
			name: json.description,
			position: json.position,
			conditionId: json.conditionId,
			data: serie,
			draggableY: true,
			dragMinY: 0,
			dragMaxY: 30,
			roundY: 10
		});
}

function addToSerie(serie, dataTime, dataValue, lastTime)
{
	var diffTime = (dataTime - lastTime);
	var diffCount = Math.floor(diffTime / 100) * 2 + (diffTime % 100);

	for (var i = 0; i < diffCount; i++)
		serie.push(dataValue);
}

function saveGraphData()
{
	if (lastSerie)
		saveSerie(lastSerie);
	else
		alert('No changed in graph !');
}

function saveSerie(serie)
{
	var oldValue;
	var graph;
	var data = [];

	for (var i = 0; i < serie.data.length; i++)
	{
		var point = serie.data[i];

		if (oldValue != point.y)
		{
			data.push({time: parseInt(point.category.replace(':', '')), value: point.y});
			oldValue = point.y;
		}
	}
	graph = {
			id: serie.options.id,
			description: serie.options.name,
			position: serie.options.position,
			conditionId: serie.options.conditionId,
			data: data
		};
	console.dir(graph);
	$.ajax({
			type: 'POST',
			url:  '/graph/' + graph.id,
			data: JSON.stringify(graph),
			dataType: 'json',
			success: function(json)
			{
				alert('Data saved !');
			},
			error: function(e)
			{
				alert('Communication error: ' + e.message);
			}
		});
}

function initChart()
{
	var category = [];

	for (var i = 0; i < 24; i += 0.5)
	{
		var h = Math.floor(i);
		var m = (i - h) * 60;

		category.push((h < 10 ? '0' + h : h) + ':' + (m == 0 ? '00' : m));
	}
	chart = new Highcharts.Chart({
			chart: {
				renderTo: 'container',
				animation: false
			},
			title: {
				text: 'Heating control'
			},
			xAxis: {
				categories: category
			},
			yAxis: {
				title: {
					text: 'Temperature'
				},
				min: 12,
				max: 25
			},
			plotOptions: {
				series: {
					cursor: 'ns-resize',
					point: {
						events: {
							drag: function (e) {
								var serie = e.target.series;

								for (var i = 0; i < serie.data.length; i++)
								{
									var point = serie.data[i];

									if (point.x == e.target.x)
									{
										var idx = i + 1;

										while (idx < serie.data.length)
										{
											if (serie.data[idx].y != e.target.y)
												break;
											serie.data[idx].y = e.newY;
											idx++;
										}
										break;
									}
								}
							},
							drop: function (dragPoint) {
								lastSerie = this.series;
							}
						}
					},
					stickyTracking: false
					},
				column: {
					stacking: 'normal'
				}
			},
			tooltip: {
				yDecimals: 1
			}
		});
}
 </script>
</body>
</html>
