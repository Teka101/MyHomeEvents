<!DOCTYPE html>
<html>
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link rel="stylesheet" href="css/bootstrap.min.css">
 <script src="js/jquery.min.js"></script>
 <script src="js/bootstrap.min.js"></script>
 <script src="js/highcharts.js"></script>
 <script src="js/highcharts-more.js"></script>
 <script src="js/draggable-points.js"></script>
</head>
<body class="container">
 <ul id="myTabs" class="nav nav-tabs" role="tablist">
  <li role="presentation" class="active"><a href="#room" aria-controls="room" role="tab" data-toggle="tab">Room</a></li>
  <li role="presentation"><a href="#cond" aria-controls="cond" role="tab" data-toggle="tab">Condition</a></li>
  <li role="presentation"><a href="#graph" aria-controls="graph" role="tab" data-toggle="tab">Graphic</a></li>
  <li role="presentation"><a href="#hard" aria-controls="hard" role="tab" data-toggle="tab">Hardwares / Devices</a></li>
 </ul>
<br>
 <div class="tab-content" style="height:100%">
  <div role="tabpanel" class="tab-pane fade in active" id="room">
   <form class="form-horizontal" role="form">
    <div class="form-group">
     <label class="col-sm-2 control-label">1 - Rooms</label>
     <div class="col-sm-10"><select id="selectRooms" class="form-control"></select></div>
    </div>
    <hr>
    <div class="form-group">
     <label class="col-sm-2 control-label">Room.id</label>
     <div class="col-sm-10"><input id="room_id" type="text" class="form-control" disabled></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Room.name</label>
     <div class="col-sm-10"><input id="room_name" type="text" class="form-control"></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Room.deviceTemperatureId</label>
     <div class="col-sm-10"><select id="room_deviceTemperatureId" class="form-control"></select></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Room.deviceHeatingId</label>
     <div class="col-sm-10"><select id="room_deviceHeatingId" class="form-control"></select></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Room.deviceHeaterId</label>
     <div class="col-sm-10"><select id="room_deviceHeaterId" class="form-control"></select></div>
    </div>
    <div class="form-group text-center">
     <button type="button" class="btn btn-primary" onClick="saveRoom()">Save</button>
    </div>
    <hr>
    <div class="form-group">
     <label class="col-sm-2 control-label">2 - RoomGraphCond</label>
     <div class="col-sm-10"><select id="selectRGCs" class="form-control"></select></div>
    </div>
    <hr>
    <div class="form-group">
     <label class="col-sm-2 control-label">RGC.id</label>
     <div class="col-sm-10"><input id="rgc_id" type="text" class="form-control" disabled></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">RGC.roomId</label>
     <div class="col-sm-10"><input id="rgc_roomId" type="text" class="form-control" disabled></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">RGC.graphId</label>
     <div class="col-sm-10"><select id="rgc_graphId" class="form-control"></select></div>
    </div>
	<div class="form-group">
     <label class="col-sm-2 control-label">RGC.conditionId</label>
     <div class="col-sm-10"><select id="rgc_conditionId" class="form-control"></select></div>
    </div>
    <div class="form-group text-center">
     <button type="button" class="btn btn-primary" onClick="saveRGC()">Save</button>
    </div>
   </form>
  </div>
  <div role="tabpanel" class="tab-pane fade" id="cond">
   <form class="form-horizontal" role="form">
    <div class="form-group">
     <label class="col-sm-2 control-label">Conditions</label>
     <div class="col-sm-10"><select id="selectConds" class="form-control"></select></div>
    </div>
    <hr>
    <div class="form-group">
     <label class="col-sm-2 control-label">Condition.id</label>
     <div class="col-sm-10"><input id="cond_id" type="text" class="form-control" disabled></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Condition.name</label>
     <div class="col-sm-10"><input id="cond_name" type="text" class="form-control"></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Condition.deviceId</label>
     <div class="col-sm-10"><select id="cond_deviceId" class="form-control"><option value="-1">none</option></select></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Condition.temperatureMin</label>
     <div class="col-sm-10"><input id="cond_temperatureMin" type="text" class="form-control"></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Condition.temperatureMax</label>
     <div class="col-sm-10"><input id="cond_temperatureMax" type="text" class="form-control"></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Condition.days</label>
     <div class="col-sm-10">
      <div class="checkbox">
        <label><input type="checkbox" name="cond_daysMon">Monday</label>
        <label><input type="checkbox" name="cond_daysTue">Tuesday</label>
        <label><input type="checkbox" name="cond_daysWed">Wednesday</label>
        <label><input type="checkbox" name="cond_daysThu">Thurday</label>
        <label><input type="checkbox" name="cond_daysFri">Friday</label>
        <label><input type="checkbox" name="cond_daysSat">Saturday</label>
        <label><input type="checkbox" name="cond_daysSun">Sunday</label>
      </div>
     </div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Condition.useCalendar</label>
     <div class="col-sm-10"><input id="cond_useCalendar" type="checkbox" class="form-control"></div>
    </div>
    <div class="form-group text-center">
     <button id="btnAddConditionDate" type="button" class="btn btn-default" onClick="addConditionDate()">Add date</button>
     <button type="button" class="btn btn-primary" onClick="saveCondition()">Save</button>
    </div>
   </form>
  </div>
  <div role="tabpanel" class="tab-pane fade" id="graph">
   <form class="form-horizontal" role="form">
    <div class="form-group">
     <label class="col-sm-2 control-label">1 - Graphics</label>
     <div class="col-sm-10"><select id="selectGraphs" class="form-control"></select></div>
    </div>
    <hr>
    <div class="form-group">
     <label class="col-sm-2 control-label">Graphic.description</label>
     <div class="col-sm-10"><input id="graph_description" type="text" class="form-control"></div>
    </div>
   </form>
   <div class="col-sm-10 text-center">
    <div id="graphContainer" style="width: 1024px; height: 400px"></div>
    <button type="button" class="btn btn-primary" onClick="chartSaveData()">Save</button>
   </div>
  </div>
  <div role="tabpanel" class="tab-pane fade" id="hard">
   <form class="form-horizontal" role="form">
    <div class="form-group">
     <label class="col-sm-2 control-label">1 - Hardwares</label>
     <div class="col-sm-10"><select id="selectHards" class="form-control"></select></div>
    </div>
    <hr>
    <div class="form-group">
     <label class="col-sm-2 control-label">Hardware.id</label>
     <div class="col-sm-10"><input id="hard_id" type="text" class="form-control" disabled></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Hardware.type</label>
     <div class="col-sm-10"><select id="hard_type" class="form-control"><option>domoticz</option><option>philipsTV</option><option>shell</option></select></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Hardware.name</label>
     <div class="col-sm-10"><input id="hard_name" type="text" class="form-control"></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Hardware.param1</label>
     <div class="col-sm-10"><input id="hard_param1" type="text" class="form-control"></div>
    </div>
    <div class="form-group text-center">
     <button type="button" class="btn btn-primary" onClick="saveHardware()">Save</button>
    </div>
    <hr>
    <div class="form-group">
     <label class="col-sm-2 control-label">2 - Devices</label>
     <div class="col-sm-10"><select id="selectDevs" class="form-control"></select></div>
    </div>
    <hr>
    <div class="form-group">
     <label class="col-sm-2 control-label">Device.id</label>
     <div class="col-sm-10"><input id="dev_id" type="text" class="form-control" disabled></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Device.type</label>
     <div class="col-sm-10"><select id="dev_type" class="form-control"><option>devTempHum</option><option>devInterruptor</option><option>devDimmer</option><option>devTV</option></select></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Device.name</label>
     <div class="col-sm-10"><input id="dev_name" type="text" class="form-control"></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Device.hardwareId</label>
     <div class="col-sm-10"><input id="dev_hardwareId" type="text" class="form-control" disabled></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Device.cacheLifetime</label>
     <div class="col-sm-10"><input id="dev_cacheLifetime" type="text" class="form-control"></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Device.param1</label>
     <div class="col-sm-10"><input id="dev_param1" type="text" class="form-control"></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Device.param2</label>
     <div class="col-sm-10"><input id="dev_param2" type="text" class="form-control"></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Device.cloneToDeviceId</label>
     <div class="col-sm-10"><select id="dev_cloneToDeviceId" class="form-control"><option value="-1">none</option></select></div>
    </div>
    <div class="form-group">
     <label class="col-sm-2 control-label">Device.hidden</label>
     <div class="col-sm-10"><input id="dev_hidden" type="checkbox" class="form-control"></div>
    </div>
    <div class="form-group text-center">
     <button type="button" class="btn btn-primary" onClick="saveDevice()">Save</button>
    </div>
   </form>
  </div>
 </div>
 <script>
var chart; //http://www.highcharts.com/docs/chart-concepts/axes
var lastSerie;
var world;

$(document).ready(function() {
	var results = window.location.href.split('#');
	var selectedTab = (results == null ? null : results[1]);

	$('#myTabs a').click(function (e) {
			e.preventDefault();
			$(this).tab('show');
		});
	$('a[data-toggle="tab"]').on('click', function(e) {
			return location.hash = $(e.target).attr('href').substr(1);
		});
	reloadWorld();
	$('#selectHards').bind('change keyup', changeHardware);
	$('#selectDevs').bind('change keyup', changeDevice);
	$('#selectGraphs').bind('change keyup', changeGraph);
	$('#selectConds').bind('change keyup', changeCondition);
	$('#selectRooms').bind('change keyup', changeRoom);
	$('#selectRGCs').bind('change keyup', changeRGC);

	if (selectedTab != null)
	{
		$('#myTabs a[href="#' + selectedTab + '"]').tab('show')
	}
});

function reloadWorld()
{
	$.ajax({
			type: 'GET',
			url:  'admin/world',
			dataType: 'json',
			success: function(json)
			{
				world = json;
				$.each(json.hardwares, function(i, item) {
						$('#selectHards').append($('<option>', { value: item.id, text: item.name }));
					});
				$.each(json.devices, function(i, item) {
						$('#cond_deviceId').append($('<option>', { value: item.id, text: item.name }));
						$('#dev_cloneToDeviceId').append($('<option>', { value: item.id, text: item.name }));
						if (item.type == 'devTempHum')
						{
							$('#room_deviceTemperatureId').append($('<option>', { value: item.id, text: item.name }));
							$('#room_deviceHeatingId').append($('<option>', { value: item.id, text: item.name }));
						}
						else if (item.type == 'devInterruptor')
							$('#room_deviceHeaterId').append($('<option>', { value: item.id, text: item.name }));
					});
				$.each(json.graphics, function(i, item) {
						$('#selectGraphs').append($('<option>', { value: item.id, text: item.description }));
						$('#rgc_graphId').append($('<option>', { value: item.id, text: item.description }));
					});
				$.each(json.conditions, function(i, item) {
						$('#selectConds').append($('<option>', { value: item.id, text: item.name }));
						$('#rgc_conditionId').append($('<option>', { value: item.id, text: item.name }));
					});
				$('#selectConds').val([]);
				$('[id^="cond_"]').val([]);
				$('[name^="cond_days"]').val([]);
				$('#btnAddConditionDate').prop('disabled', true);
				$.each(json.rooms, function(i, item) {
						$('#selectRooms').append($('<option>', { value: item.id, text: item.name }));
					});
				resetHardware();
				$('#cond_deviceId').val([]);
				$('#room_deviceTemperatureId').val([]);
				$('#room_deviceHeatingId').val([]);
				$('#room_deviceHeaterId').val([]);
				$('#selectGraphs').val([]);
				$('[id^="graph_"]').val([]);
				resetRoom();
			},
			error: function(e)
			{
				alert('Communication error: ' + e.message);
			}
		});
}

function changeHardware()
{
	var hardwareId = $(this).val();

	$.each(world.hardwares, function(i, item) {
			if (item.id == hardwareId)
				for (var k in item)
					$('#hard_' + k).val(item[k]);
		});
	$('#selectDevs option').remove();
	$.each(world.devices, function(i, item) {
			if (item.hardwareId == hardwareId)
				$('#selectDevs').append($('<option>', { value: item.id, text: item.name }));
		});
	resetDevice();
}

function changeDevice()
{
	var deviceId = $(this).val();

	$.each(world.devices, function(i, item) {
			if (item.id == deviceId)
				for (var k in item)
				{
					var v = item[k];

					if (v == 'true' || v == 'false')
						$('#dev_' + k).prop('checked', v == 'true');
					else
						$('#dev_' + k).val(v);
				}
		});
}

function changeGraph()
{
	var graphId = $(this).val();

	$.each(world.graphics, function(i, item) {
			if (item.id == graphId)
			{
				chartUpdate(item);
				for (var k in item)
					$('#graph_' + k).val(item[k]);
			}
		});
}

function changeCondition()
{
	var conditionId = $(this).val();

	$.each(world.conditions, function(i, item) {
			if (item.id == conditionId)
			{
				for (var k in item)
				{
					var v = item[k];

					if (v == 'true' || v == 'false')
						$('#cond_' + k).prop('checked', v == 'true');
					else
						$('#cond_' + k).val(v);
				}
				$('#btnAddConditionDate').prop('disabled', item.useCalendar == 'false');
				$('input[name="cond_daysMon"]').prop('checked', (parseInt(item.days) & 64) == 64);
				$('input[name="cond_daysTue"]').prop('checked', (parseInt(item.days) & 32) == 32);
				$('input[name="cond_daysWed"]').prop('checked', (parseInt(item.days) & 16) == 16);
				$('input[name="cond_daysThu"]').prop('checked', (parseInt(item.days) & 8) == 8);
				$('input[name="cond_daysFri"]').prop('checked', (parseInt(item.days) & 4) == 4);
				$('input[name="cond_daysSat"]').prop('checked', (parseInt(item.days) & 2) == 2);
				$('input[name="cond_daysSun"]').prop('checked', (parseInt(item.days) & 1) == 1);
			}
		});
}

function changeRoom()
{
	var roomId = $(this).val();

	$.each(world.rooms, function(i, item) {
			if (item.id == roomId)
				for (var k in item)
				{
					var v = item[k];

					if (k.startsWith('device') && v == -1)
						$('#room_' + k).val([]);
					else
						$('#room_' + k).val(v);
				}
		});
	$.each(world.roomGraphConds, function(i, item) {
			if (item.roomId == roomId)
				$('#selectRGCs').append($('<option>', { value: item.id, text: '#' + item.id }));
		});
	resetRGC();
}

function changeRGC()
{
	var rgcId = $(this).val();

	$.each(world.roomGraphConds, function(i, item) {
			if (item.id == rgcId)
				for (var k in item)
				{
					var v = item[k];

					if (v == -1)
						$('#rgc_' + k).val([]);
					else
						$('#rgc_' + k).val(v);
				}
		});
}

function resetHardware()
{
	$('#selectHards').val([]);
	$('[id^="hard_"]').val([]);
	resetDevice();
}

function resetDevice()
{
	$('#selectDevs').val([]);
	$('[id^="dev_"]').val([]);
}

function resetRoom()
{
	$('#selectRooms').val([]);
	$('[id^="room_"]').val([]);
	resetRGC();
}

function resetRGC()
{
	$('[id^="rgc_"]').val([]);
	$('#selectRGCs').val([]);
}

function chartUpdate(json)
{
	var serie = [];
	var lastValue = 12;
	var lastTime = 0;

	for (var key in json.data)
	{
		var data = json.data[key];
		var dataTime = parseInt(data.time);
		var dataValue = parseFloat(data.value);

		chartAddToSerie(serie, dataTime, lastValue, lastTime);
		lastValue = dataValue;
		lastTime = dataTime;
	}
	chartAddToSerie(serie, 2400, lastValue, lastTime);
	initChart();
	chart.addSeries({
			id: json.id,
			name: json.description,
			position: json.position,
			data: serie,
			draggableY: true,
			dragMinY: 0,
			dragMaxY: 30,
			roundY: 10
		});
}

function chartAddToSerie(serie, dataTime, dataValue, lastTime)
{
	var diffTime = (dataTime - lastTime);
	var diffCount = Math.floor(diffTime / 100) * 2 + Math.floor(((diffTime % 100) / 100) * 2);

	for (var i = 0; i < diffCount; i++)
		serie.push(dataValue);
}

function initChart()
{
	var category = [];

	for (var i = 0; i < 24; i += 0.5)
	{
		var h = Math.floor(i);
		var m = (i - h) * 60;

		category.push((h < 10 ? '0' + h : h) + ':' + (m == 0 ? '00' : m));
	}
	if (chart != null)
		chart.destroy();
	chart = new Highcharts.Chart({
			chart: {
				renderTo: 'graphContainer',
				animation: false
			},
			title: {
				text: ''
			},
			xAxis: {
				categories: category
			},
			yAxis: {
				title: {
					text: 'Temperature'
				},
				min: 12,
				max: 25
			},
			plotOptions: {
				series: {
					cursor: 'ns-resize',
					point: {
						events: {
							drag: function (e) {
								var serie = e.target.series;

								for (var i = 0; i < serie.data.length; i++)
								{
									var point = serie.data[i];

									if (point.x == e.target.x)
									{
										var idx = i + 1;

										while (idx < serie.data.length)
										{
											if (serie.data[idx].y != e.target.y)
												break;
											serie.data[idx].y = e.newY;
											idx++;
										}
										break;
									}
								}
							},
							drop: function (dragPoint) {
								lastSerie = this.series;
							}
						}
					},
					stickyTracking: false
					},
				column: {
					stacking: 'normal'
				}
			},
			tooltip: {
				yDecimals: 1
			}
		});
}

function chartSaveData()
{
	if (lastSerie == null)
	{
		alert('No changed in graph !');
		return;
	}

	var serie = lastSerie;
	var oldValue;
	var graph;
	var data = [];

	for (var i = 0; i < serie.data.length; i++)
	{
		var point = serie.data[i];

		if (oldValue != point.y)
		{
			data.push({time: parseInt(point.category.replace(':', '')), value: point.y});
			oldValue = point.y;
		}
	}
	graph = {
			id: serie.options.id,
			description: $('#graph_description').val(),
			position: serie.options.position,
			data: data
		};
	sendSave('admin/graph/', graph);
}

function addConditionDate()
{
	var dateStr = prompt('Please enter a date (format: YYYYMMDD)', new Date().toISOString().substring(0, 10).replace(/-/g, ''));
	var date = parseInt(dateStr);

	if (!isNaN(date))
		sendSave('admin/condition/' + $('#cond_id').val() + '/addDate/' + date, null);
}

function saveHardware()
{
	var obj = {};

	$('[id^="hard_"]').each(function(index) {
			obj[$(this).attr('id').replace(/^.*_/, '')] = $(this).val();
		});
	sendSave('admin/hardware/', obj);
}

function saveDevice()
{
	var obj = {};

	$('[id^="dev_"]').each(function(index) {
			obj[$(this).attr('id').replace(/^.*_/, '')] = $(this).val();
		});
	obj.hidden = $('#dev_hidden').is(':checked');
	sendSave('admin/device/', obj);
}

function saveCondition()
{
	var obj = {};

	$('[id^="cond_"]').each(function(index) {
			obj[$(this).attr('id').replace(/^.*_/, '')] = $(this).val();
		});
	obj.useCalendar = $('#cond_useCalendar').is(':checked');
	obj.days =
		($('input[name="cond_daysMon"]').prop('checked') ? 64 : 0)
		| ($('input[name="cond_daysTue"]').prop('checked') ? 32 : 0)
		| ($('input[name="cond_daysWed"]').prop('checked') ? 16 : 0)
		| ($('input[name="cond_daysThu"]').prop('checked') ? 8 : 0)
		| ($('input[name="cond_daysFri"]').prop('checked') ? 4 : 0)
		| ($('input[name="cond_daysSat"]').prop('checked') ? 2 : 0)
		| ($('input[name="cond_daysSun"]').prop('checked') ? 1 : 0)
		;
	sendSave('admin/condition/', obj);
}

function saveRoom()
{
	var obj = {};

	$('[id^="room_"]').each(function(index) {
			obj[$(this).attr('id').replace(/^.*_/, '')] = $(this).val();
		});
	sendSave('admin/room/', obj);
}

function saveRGC()
{
	var obj = {};

	$('[id^="rgc_"]').each(function(index) {
			obj[$(this).attr('id').replace(/^.*_/, '')] = $(this).val();
		});
	sendSave('admin/rgc/', obj);
}

function sendSave(url, obj)
{
	var method = (obj == null ? 'GET' : 'POST');
	var fullUrl = (obj == null ? url : url + obj.id);
	var serializedData = (obj == null ? null : JSON.stringify(obj));

	console.dir(obj);
	$.ajax({
			type: method,
			url:  fullUrl,
			data: serializedData,
			dataType: 'json',
			success: function(json)
			{
				if (obj != null)
				{
					alert('Data saved ! (page should be reloaded)');
					location.reload();
				}
				else
					alert('Data saved !');
			},
			error: function(e)
			{
				alert('Communication error: ' + e.message);
			}
		});
}
 </script>
</body>
</html>
